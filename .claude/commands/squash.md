---
name: squash
description: Commit å†å²æ•´ç†ä¸åˆå¹¶
version: 0.0.1
tags:
  - git
  - rebase
  - commit
  - workflow
dependencies:
  git: "any"
---

# Commit å†å²æ•´ç†

> **TDD äº§ç”Ÿçš„å° commit åº”è¯¥åœ¨åŠŸèƒ½å®Œæˆåæ•´ç†**

å°† TDD å¾ªç¯äº§ç”Ÿçš„å¤šä¸ªç»†ç¢ commit åˆå¹¶ä¸ºæœ‰æ„ä¹‰çš„åŠŸèƒ½ commitã€‚

---

## å¿«æ·å‘½ä»¤

```bash
/squash              # äº¤äº’å¼å¼•å¯¼
/squash feature       # åˆå¹¶å•ä¸ªåŠŸèƒ½çš„æ‰€æœ‰ commit
/squash interactive   # äº¤äº’å¼ rebase
/squash abort         # ä¸­æ­¢ rebase
```

---

## 1. æ•´ç†ç­–ç•¥

### 1.1 TDD Commit æ¨¡å¼

```
å•ä¸ªåŠŸèƒ½å¼€å‘è¿‡ç¨‹ï¼š
test: æ·»åŠ  xxx æµ‹è¯•
feat: å®ç°ä½¿æµ‹è¯•é€šè¿‡çš„ xxx
refactor: æå–å‡½æ•°
refactor: ä¼˜åŒ–é€»è¾‘
...
```

**é—®é¢˜**ï¼šç»†ç¢ã€ä¸­é—´æ€ã€éš¾ä»¥å®¡æŸ¥

### 1.2 æ¨èç­–ç•¥ï¼ˆæ–¹æ¡ˆ Bï¼‰

| é˜¶æ®µ | ç­–ç•¥ | è¯´æ˜ |
|------|------|------|
| **å¼€å‘ä¸­** | ä¿æŒå° commit | ä¾¿äºå›æ»šå’Œè°ƒè¯• |
| **åŠŸèƒ½å®Œæˆå** | åˆå¹¶ä¸º 1 ä¸ª commit | æœ‰æ„ä¹‰çš„ commit message |
| **æ¨é€å‰æ•´ç†** | æ¸…ç†æœ¬åœ°å†å² | ä¿æŒåˆ†æ”¯å¹²å‡€ |

### 1.3 åˆå¹¶æ—¶æœº

```
âœ… é€‚åˆåˆå¹¶ï¼š
- åŠŸèƒ½å¼€å‘å®Œæˆ
- æœ¬åœ°åŠŸèƒ½åˆ†æ”¯
- å‡†å¤‡æ¨é€åˆ°è¿œç¨‹

âŒ ä¸é€‚åˆåˆå¹¶ï¼š
- å·²æ¨é€åˆ°è¿œç¨‹å…±äº«åˆ†æ”¯
- ä¸ä»–äººåä½œçš„åˆ†æ”¯
- å…¬å…±åˆ†æ”¯ï¼ˆmain/masterï¼‰
```

---

## 2. å®‰å…¨æ£€æŸ¥

### 2.1 åˆå¹¶å‰æ£€æŸ¥

```bash
# 1. æ£€æŸ¥åˆ†æ”¯çŠ¶æ€
git status

# 2. æ£€æŸ¥æ˜¯å¦å·²æ¨é€
git log --oneline @{u}..
# å¦‚æœæœ‰è¾“å‡ºï¼Œè¯´æ˜æœ‰æœªæ¨é€çš„ commitï¼ˆå®‰å…¨ï¼‰

# 3. æ£€æŸ¥è¿œç¨‹åˆ†æ”¯
git branch -r
# å¦‚æœåˆ†æ”¯åœ¨è¿œç¨‹ï¼Œä¸è¦é‡å†™å·²æ¨é€çš„å†å²
```

### 2.2 é£é™©ä¿¡å·

| ä¿¡å· | é£é™©ç­‰çº§ | å¤„ç† |
|------|----------|------|
| å·²æ¨é€åˆ°ä¸ªäººè¿œç¨‹åˆ†æ”¯ | ğŸŸ¡ ä¸­ | å¯åˆå¹¶ï¼Œéœ€ force push |
| å·²æ¨é€åˆ°å…±äº«åˆ†æ”¯ | ğŸ”´ é«˜ | ä¸è¦é‡å†™å†å² |
| ä»–äººåŸºäºæ­¤åˆ†æ”¯å·¥ä½œ | ğŸ”´ é«˜ | ä¸è¦é‡å†™å†å² |

---

## 3. äº¤äº’å¼ Rebase

### 3.1 åˆå¹¶æœ€è¿‘ N ä¸ª commit

```bash
# æŸ¥çœ‹æœ€è¿‘ commit
git log --oneline -10

# åˆå¹¶æœ€è¿‘ 6 ä¸ª commitï¼ˆ1 ä¸ªåŠŸèƒ½ = 3~5 ä¸ª commitï¼‰
git rebase -i HEAD~6

# æˆ–æŒ‡å®šèµ·å§‹ commit
git rebase -i <commit-hash>
```

### 3.2 Rebase Todo å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `pick` | ä¿ç•™æ­¤ commit |
| `squash` | åˆå¹¶åˆ°å‰ä¸€ä¸ª commit |
| `fixup` | åˆå¹¶åˆ°å‰ä¸€ä¸ªï¼Œä¸¢å¼ƒ commit message |
| `drop` | åˆ é™¤æ­¤ commit |
| `reword` | ä¿®æ”¹ commit message |
| `edit` | åœåœ¨æ­¤ commit ä¿®æ”¹å†…å®¹ |

### 3.3 åˆå¹¶ç¤ºä¾‹

**Before**ï¼ˆrebase -i ç¼–è¾‘å™¨ï¼‰ï¼š
```
pick abc1234 test: æ·»åŠ è®¢å•æµ‹è¯•
pick def5678 feat: å®ç°è®¢å•åŠŸèƒ½
pick ghi9012 refactor: æå–éªŒè¯å‡½æ•°
pick jkl3456 refactor: ä¼˜åŒ–æŠ˜æ‰£è®¡ç®—
```

**After**ï¼ˆåˆå¹¶ä¸º 1 ä¸ªï¼‰ï¼š
```
pick abc1234 test: æ·»åŠ è®¢å•æµ‹è¯•
fixup def5678 feat: å®ç°è®¢å•åŠŸèƒ½
fixup ghi9012 refactor: æå–éªŒè¯å‡½æ•°
fixup jkl3456 refactor: ä¼˜åŒ–æŠ˜æ‰£è®¡ç®—
```

**ç»“æœ**ï¼šä¿ç•™ç¬¬ä¸€ä¸ª commit çš„ messageï¼Œåˆå¹¶å…¶ä»– commit çš„å˜æ›´

---

## 4. å¸¸è§åœºæ™¯

### 4.1 åˆå¹¶å•ä¸ªåŠŸèƒ½çš„æ‰€æœ‰ commit

```bash
# 1. ç¡®å®šåŠŸèƒ½èµ·å§‹ commit
git log --oneline -10

# 2. äº¤äº’å¼ rebase
git rebase -i HEAD~4

# 3. å°†åç»­ commit æ”¹ä¸º fixup
# pick abc1234 feat: å®ç°è®¢å•åŠŸèƒ½
# fixup def5678 refactor: æå–å‡½æ•°
# fixup ghi9012 refactor: ä¼˜åŒ–é€»è¾‘

# 4. ä¿å­˜é€€å‡ºï¼ŒGit è‡ªåŠ¨åˆå¹¶
```

### 4.2 åˆ é™¤è°ƒè¯• commit

```bash
# 1. äº¤äº’å¼ rebase
git rebase -i HEAD~5

# 2. å°†è°ƒè¯• commit æ”¹ä¸º drop
# pick abc1234 feat: å®ç°åŠŸèƒ½
# drop def5678 debug: ä¿®å¤æµ‹è¯•
# drop ghi9012 debug: è°ƒæ•´é€»è¾‘
# pick jkl3456 refactor: ä¼˜åŒ–ä»£ç 
```

### 4.3 ä¿®æ”¹ Commit Message

```bash
# 1. äº¤äº’å¼ rebase
git rebase -i HEAD~3

# 2. å°†è¦ä¿®æ”¹çš„ commit æ”¹ä¸º reword
# pick abc1234 feat: å®ç°åŠŸèƒ½
# reword def5678 refactor: ä¼˜åŒ–ä»£ç 

# 3. ä¿å­˜åä¼šè¿›å…¥ç¼–è¾‘å™¨ä¿®æ”¹ message
```

### 4.4 å¿«é€Ÿåˆå¹¶ï¼ˆè‡ªåŠ¨è„šæœ¬ï¼‰

```bash
# æ–¹å¼ Aï¼šè½¯é‡ç½®åé‡æ–°æäº¤
git reset --soft HEAD~4      # æ’¤é”€ 4 ä¸ª commitï¼Œä¿ç•™å˜æ›´
git commit -m "feat: å®ç°å®Œæ•´è®¢å•åŠŸèƒ½"  # é‡æ–°æäº¤

# æ–¹å¼ Bï¼šä½¿ç”¨ fixup è‡ªåŠ¨åˆå¹¶
GIT_SEQUENCE_EDITOR="sed -i '2,$s/^pick/fixup/'" git rebase -i HEAD~4
```

---

## 5. å¼ºåˆ¶æ¨é€

### 5.1 æ¨é€é‡å†™çš„å†å²

```bash
# åˆå¹¶å®Œæˆåï¼Œå¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹
git push --force-with-lease origin feature-branch

# æˆ–ä½¿ç”¨ç®€å†™ï¼ˆæ›´å±é™©ï¼‰
git push -f origin feature-branch
```

### 5.2 Force With Lease

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `--force-with-lease` | **æ¨è**ï¼šå¦‚æœè¿œç¨‹æœ‰æ–°æäº¤åˆ™å¤±è´¥ |
| `--force` / `-f` | å¼ºåˆ¶è¦†ç›–ï¼Œå¯èƒ½ä¸¢å¤±ä»–äººæäº¤ |

---

## 6. æ•…éšœæ¢å¤

### 6.1 ä¸­æ­¢ Rebase

```bash
# åœ¨ rebase è¿‡ç¨‹ä¸­æ”¾å¼ƒ
git rebase --abort

# æ¢å¤åˆ° rebase å‰çš„çŠ¶æ€
git reflog
git reset --hard HEAD@{N}
```

### 6.2 å†²çªå¤„ç†

```bash
# Rebase è¿‡ç¨‹ä¸­é‡åˆ°å†²çª
# 1. è§£å†³å†²çª
# 2. git add <files>
# 3. git rebase --continue
# 4. é‡å¤ç›´åˆ°å®Œæˆ

# æ”¾å¼ƒ rebase
git rebase --abort
```

---

## 7. å®Œæ•´ç¤ºä¾‹

### åœºæ™¯ï¼šè®¢å•åŠŸèƒ½å®Œæˆåæ•´ç† commit

**åŸå§‹ commit å†å²**ï¼š
```
abc1234 feat: å®ç°è®¢å•åˆ›å»º
def5678 refactor: æå–åº“å­˜éªŒè¯
ghi9012 refactor: æå–æŠ˜æ‰£è®¡ç®—
jkl3456 refactor: ä¼˜åŒ–è®¢å•ä¿å­˜
mno6789 test: è¡¥å……è®¢å•æµ‹è¯•
```

**æ“ä½œ**ï¼š
```bash
# 1. äº¤äº’å¼ rebase
git rebase -i HEAD~5

# 2. ç¼–è¾‘ä¸ºï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªï¼Œå…¶ä»– fixupï¼‰
pick abc1234 feat: å®ç°è®¢å•åˆ›å»º
fixup def5678 refactor: æå–åº“å­˜éªŒè¯
fixup ghi9012 refactor: æå–æŠ˜æ‰£è®¡ç®—
fixup jkl3456 refactor: ä¼˜åŒ–è®¢å•ä¿å­˜
fixup mno6789 test: è¡¥å……è®¢å•æµ‹è¯•

# 3. ä¿å­˜é€€å‡ºï¼Œè‡ªåŠ¨åˆå¹¶

# 4. æ¸…ç†ä¸å¯è¾¾å¯¹è±¡ï¼ˆå¿«é€Ÿï¼‰
git gc --prune=now
```

**ç»“æœ**ï¼š
```
abc1234 feat: å®ç°è®¢å•åˆ›å»º
```

---

## 8. æ¸…ç†ç©ºé—´

Squash åï¼ŒåŸå§‹ commit å˜ä¸ºä¸å¯è¾¾å¯¹è±¡ï¼Œå ç”¨ç©ºé—´ã€‚

### å¿«é€Ÿæ¸…ç†ï¼ˆæ¨èï¼‰

```bash
git gc --prune=now
```

- **è€—æ—¶**ï¼šå‡ ç§’åˆ°å‡ åˆ†é’Ÿ
- **æ•ˆæœ**ï¼šåˆ é™¤ä¸å¯è¾¾å¯¹è±¡ï¼Œå‡å° .git å¤§å°
- **å»ºè®®**ï¼šæ¯æ¬¡ squash åè¿è¡Œ

### æ¿€è¿›æ¸…ç†ï¼ˆå¯é€‰ï¼‰

```bash
git gc --aggressive --prune=now
```

- **è€—æ—¶**ï¼šæ•°åˆ†é’Ÿåˆ°æ•°å°æ—¶
- **æ•ˆæœ**ï¼šé‡æ–°å‹ç¼©æ‰€æœ‰å¯¹è±¡ï¼Œæœ€å¤§åŒ–å‡å°ç©ºé—´
- **å»ºè®®**ï¼šä»…åœ¨ .git è¿‡å¤§ï¼ˆ>500MBï¼‰æ—¶ä½¿ç”¨

---

## 9. æœ€ä½³å®è·µ

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **æœ¬åœ°å¯ä»¥ä¹±** | å¼€å‘æ—¶ä¿æŒå° commit |
| **æ¨é€å‰æ•´ç†** | åˆå¹¶ä¸ºæœ‰æ„ä¹‰çš„ commit |
| **ä¿æŠ¤å…±äº«åˆ†æ”¯** | ä¸è¦é‡å†™å·²æ¨é€çš„å…±äº«å†å² |
| **å›¢é˜Ÿçº¦å®š** | ä¸å›¢é˜Ÿçº¦å®š commit æ•´ç†ç­–ç•¥ |

---

**å° commit å¼€å‘ â†’ æ•´ç†åæ¨é€ â†’ å¹²å‡€çš„å†å²**
