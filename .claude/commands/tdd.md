---
name: tdd
description: æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTDDï¼‰æµç¨‹åŠ©æ‰‹
version: 0.0.4
tags:
  - testing
  - tdd
  - workflow
  - git
  - session
dependencies:
  git: "any"
---

# TDD ç¼–ç¨‹æ¨¡å¼

> **å¿«é€Ÿåé¦ˆæ˜¯ TDD çš„æ ¸å¿ƒ**

ä¸¥æ ¼éµå¾ªæµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTest-Driven Developmentï¼‰æµç¨‹ï¼šçº¢ â†’ ç»¿ â†’ é‡æ„ã€‚

---

## 1. TDD å¾ªç¯

### 1.1 ğŸ”´ çº¢ - ç¼–å†™å¤±è´¥çš„æµ‹è¯•

```bash
# åªè¿è¡Œæ–°æµ‹è¯•
pytest tests/test_new_feature.py -v

# æˆ–å…³é”®å­—è¿‡æ»¤
pytest -k "test_new_function" -v
```

**Git**ï¼š`git commit -m "test: æ·»åŠ  xxx åŠŸèƒ½çš„å¤±è´¥æµ‹è¯•"`

### 1.2 ğŸŸ¢ ç»¿ - ç¼–å†™æœ€å°‘ä»£ç ä½¿æµ‹è¯•é€šè¿‡

```bash
# åªè¿è¡Œå½“å‰åŠŸèƒ½æµ‹è¯•
pytest tests/test_new_feature.py -v
```

**Git**ï¼š`git commit -m "feat: å®ç°ä½¿æµ‹è¯•é€šè¿‡çš„ xxx åŠŸèƒ½"`

### 1.3 â™»ï¸ é‡æ„ - åœ¨æµ‹è¯•ä¿æŠ¤ä¸‹ä¼˜åŒ–ä»£ç 

```bash
# è¿è¡Œå—å½±å“çš„æ¨¡å—æµ‹è¯•
pytest tests/test_module.py -v
```

**Git**ï¼š`git commit -m "refactor: é‡æ„ xxx åŠŸèƒ½ä»£ç "`

---

## 2. æµ‹è¯•è¿è¡Œç­–ç•¥

| åœºæ™¯ | å‘½ä»¤ |
|------|------|
| å¼€å‘å•ä¸ªåŠŸèƒ½ | `pytest tests/test_xxx.py` |
| è°ƒè¯•ç‰¹å®šæµ‹è¯• | `pytest -k "test_login"` |
| é‡è·‘å¤±è´¥æµ‹è¯• | `pytest --lf` |
| å¤±è´¥ä¼˜å…ˆ | `pytest --ff` |
| æŒ‰ç±»å‹è¿è¡Œ | `pytest -m unit` |

**æäº¤å‰éªŒè¯**ï¼š`pytest && uv run ruff check && uv run mypy .`

---

## 3. æµ‹è¯•è§„èŒƒï¼ˆç®€è¿°ï¼‰

| è§„èŒƒ | è¦æ±‚ |
|------|------|
| **AAA æ¨¡å¼** | Arrangeï¼ˆå‡†å¤‡ï¼‰â†’ Actï¼ˆæ‰§è¡Œï¼‰â†’ Assertï¼ˆæ–­è¨€ï¼‰ |
| **å‘½åè§„èŒƒ** | `test_<åŠŸèƒ½>_<æ¡ä»¶>_<æœŸæœ›>` |
| **å•ä¸€èŒè´£** | ä¸€ä¸ªæµ‹è¯•ä¸€ä¸ªè¡Œä¸ºï¼Œâ‰¤20 è¡Œ |
| **æµ‹è¯•é‡‘å­—å¡”** | å•å…ƒ 70% / é›†æˆ 20% / E2E 10% |
| **Mock è§„åˆ™** | åªéš”ç¦»å¤–éƒ¨ä¾èµ–ï¼ˆAPI/DB/æ–‡ä»¶ç³»ç»Ÿï¼‰ |
| **è¦†ç›–ç‡** | æ ¸å¿ƒ â‰¥80%ï¼Œæ•´ä½“ â‰¥70% |

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 å¢é‡æµ‹è¯•

| æŠ€å·§ | å‘½ä»¤ |
|------|------|
| æŒ‡å®šæ–‡ä»¶ | `pytest tests/test_user.py` |
| å…³é”®å­—è¿‡æ»¤ | `pytest -k "login"` |
| Marker åˆ†ç»„ | `pytest -m unit` |
| å¹¶è¡Œæ‰§è¡Œ | `pytest -n auto` |
| å¤±è´¥é‡è·‘ | `pytest --lf` |

### 4.2 åŠ é€Ÿå‘½ä»¤

```bash
pytest -n auto          # å¹¶è¡Œæ‰§è¡Œï¼ˆéœ€ pytest-xdistï¼‰
pytest --lf             # åªè¿è¡Œä¸Šæ¬¡å¤±è´¥çš„
pytest --ff             # å…ˆè¿è¡Œå¤±è´¥çš„
pytest -x               # ç¬¬ä¸€ä¸ªå¤±è´¥ååœæ­¢
pytest --durations=10   # æ˜¾ç¤ºæœ€æ…¢çš„ 10 ä¸ªæµ‹è¯•
```

### 4.3 Mock å¤–éƒ¨ä¾èµ–

```python
# âŒ æ…¢ï¼šçœŸå®æ•°æ®åº“è°ƒç”¨
def test_get_user():
    user = db.query(User, 1)  # æ…¢ï¼
    assert user.name == "Alice"

# âœ… å¿«ï¼šMock æ•°æ®åº“
def test_get_user(mock_db):
    mock_db.return_value = User(id=1, name="Alice")
    user = get_user(1)
    assert user.name == "Alice"
```

---

## 5. é—ç•™ä»£ç å¤„ç†

1. å…ˆè¡¥å……æµ‹è¯•ï¼ˆæµ‹è¯•å…ˆè¡Œé‡æ„ï¼‰
2. è¿è¡Œæµ‹è¯•ç¡®è®¤é€šè¿‡
3. å†è¿›è¡Œä¿®æ”¹

```bash
pytest tests/test_legacy.py -v
git commit -m "test: è¡¥å……é—ç•™ä»£ç çš„æµ‹è¯•"
```

---

## 6. Git æäº¤è§„èŒƒ

| é˜¶æ®µ | å‰ç¼€ | ç¤ºä¾‹ |
|------|------|------|
| çº¢ï¼ˆæµ‹è¯•ï¼‰ | `test:` | `test: æ·»åŠ ç”¨æˆ·ç™»å½•çš„å¤±è´¥æµ‹è¯•` |
| ç»¿ï¼ˆå®ç°ï¼‰ | `feat:` | `feat: å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½` |
| é‡æ„ | `refactor:` | `refactor: ä¼˜åŒ–ç™»å½•éªŒè¯é€»è¾‘` |
| ä¿®å¤ | `fix:` | `fix: ä¿®å¤ç™»å½•éªŒè¯ bug` |

---

## 7. çŠ¶æ€æŠ¥å‘Š

### 7.1 æ‰‹åŠ¨çŠ¶æ€æŠ¥å‘Š

```markdown
## å½“å‰çŠ¶æ€
**é˜¶æ®µ**ï¼š[ğŸ”´ çº¢ / ğŸŸ¢ ç»¿ / â™»ï¸ é‡æ„]

## æµ‹è¯•ç»“æœ
- è¿è¡Œï¼š`pytest tests/test_xxx.py`
- ç»“æœï¼šé€šè¿‡/å¤±è´¥

## Git æäº¤
- `test/feat/refactor: æè¿°`

## ä¸‹ä¸€æ­¥
ç»§ç»­å®ç° / é‡æ„ / æäº¤éªŒè¯
```

### 7.2 ä¼šè¯çŠ¶æ€æŠ¥å‘Š

ä½¿ç”¨ä¼šè¯æ¨¡å¼æ—¶ï¼Œè‡ªåŠ¨è¿½è¸ªçŠ¶æ€ï¼š

```bash
/tdd --status
```

è¾“å‡ºï¼š
```
ğŸ”„ TDD ä¼šè¯ï¼ˆç¬¬ 3 æ¬¡è¿­ä»£ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š å½“å‰çŠ¶æ€                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é˜¶æ®µï¼šğŸŸ¢ ç»¿                            â”‚
â”‚  æµ‹è¯•ï¼štests/test_auth.py               â”‚
â”‚  ç»“æœï¼šâŒ FAILED                        â”‚
â”‚  å¤±è´¥ï¼šAssertionError                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¦ Gitï¼š2 ä¸ª commit                    â”‚
â”‚  ğŸ”„ é™åˆ¶ï¼š3 / 20 æ¬¡è¿­ä»£                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. TDD ä¼šè¯æ¨¡å¼

### 8.1 è‡ªåŠ¨ä¼šè¯

è¿è¡Œ `/tdd` æ—¶è‡ªåŠ¨ç®¡ç†ä¼šè¯ï¼Œæ— éœ€é¢å¤–å‚æ•°ã€‚

é¦–æ¬¡è¿è¡Œï¼šåˆ›å»ºä¼šè¯æ–‡ä»¶ `tmp/tdd-session-<timestamp>.json`
åç»­è¿è¡Œï¼šè‡ªåŠ¨æ¢å¤æœ€æ–°ä¼šè¯

### 8.2 ä¼šè¯æ–‡ä»¶

ä¼šè¯çŠ¶æ€ä¿å­˜åœ¨ `tmp/tdd-session-<timestamp>.json`ï¼š

```json
{
  "session_id": "tdd-20250104-143022",
  "phase": "green",
  "iteration": 3,
  "max_iterations": 20,
  "current_test_file": "tests/test_auth.py",
  "current_test_function": "test_login_success",
  "last_test_result": "FAILED",
  "last_test_output": "tests/test_auth.py:5: AssertionError\nassert login_result.success == True",
  "git_commit_count": 2,
  "start_time": "2025-01-04T14:30:22",
  "last_update": "2025-01-04T14:35:10"
}
```

### 8.3 ä¼šè¯æ¢å¤

æ£€æµ‹åˆ°ä¼šè¯æ—¶è‡ªåŠ¨æ˜¾ç¤ºï¼š

```
ğŸ”„ TDD ä¼šè¯æ¢å¤

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š ä¼šè¯ä¿¡æ¯                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¼€å§‹æ—¶é—´ï¼š2å°æ—¶å‰                      â”‚
â”‚  è¿­ä»£æ¬¡æ•°ï¼š3 æ¬¡                         â”‚
â”‚  å½“å‰é˜¶æ®µï¼šğŸŸ¢ ç»¿                        â”‚
â”‚  å½“å‰æµ‹è¯•ï¼štests/test_auth.py          â”‚
â”‚  ä¸Šæ¬¡ç»“æœï¼šâŒ FAILED                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’¬ å¤±è´¥åŸå› ï¼š                          â”‚
â”‚  AssertionError: Expected True, got Falseâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¦ Gitï¼š2 ä¸ª commit                    â”‚
â”‚  ğŸ”„ é™åˆ¶ï¼š3 / 20 æ¬¡è¿­ä»£                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»§ç»­ä¸Šæ¬¡å·¥ä½œ...
```

### 8.4 æ‰‹åŠ¨ç®¡ç†

```bash
# å–æ¶ˆå½“å‰ä¼šè¯
rm tmp/tdd-session-*.json

# æŸ¥çœ‹æ‰€æœ‰ä¼šè¯
ls -lh tmp/tdd-session-*.json

# æ¸…ç†æ—§ä¼šè¯ï¼ˆ>7å¤©ï¼‰
find tmp/ -name "tdd-session-*.json" -mtime +7 -delete
```

### 8.5 æƒé™å¤„ç†

å¦‚æœ `tmp/` ä¸å¯å†™ï¼Œè‡ªåŠ¨é™çº§ï¼š
1. `/tmp/` ç›®å½•
2. `$HOME/.cache/claude-code/`

å¦‚æœéƒ½å¤±è´¥ï¼ŒTDD æ­£å¸¸è¿è¡Œä½†ä¸ä¿å­˜çŠ¶æ€ã€‚

### 8.6 Git Worktree æ”¯æŒ

æ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³ï¼Œå¤šä¸ª worktree ä¸ä¼šå†²çªï¼š
```
project/          â†’ tmp/tdd-session-20250104-143022.json
project-feature/  â†’ tmp/tdd-session-20250104-150530.json
```

---

**å¿«é€Ÿåé¦ˆ â†’ å¿«é€Ÿè¿­ä»£ â†’ é«˜è´¨é‡ä»£ç **
