name: Claude Code Plugin Test

on:
  push:
    branches: [ main, master ]
    paths:
      - '.claude-plugin/marketplace.json'
      - 'plugins/**'
      - '.github/workflows/plugin-test.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - '.claude-plugin/marketplace.json'
      - 'plugins/**'
      - '.github/workflows/plugin-test.yml'
  workflow_dispatch:

env:
  NODE_VERSION: 24

jobs:
  plugin-test:
    name: Claude Code Plugin Test
    runs-on: ubuntu-latest
    environment: cc
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    strategy:
      matrix:
        node-version: [24]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          claude --version

      - name: Verify Claude Code installation
        run: |
          claude --help
          claude --version

      - name: Validate marketplace.json schema
        run: |
          echo "üîç Validating marketplace.json schema..."
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "‚ùå marketplace.json not found"
            exit 1
          fi

          # Basic JSON validation
          jq empty .claude-plugin/marketplace.json
          if [ $? -ne 0 ]; then
            echo "‚ùå marketplace.json is not valid JSON"
            exit 1
          fi

          echo "‚úÖ marketplace.json schema is valid"

      - name: Setup Environment Variables
        run: |
          echo "üîß Setting up environment variables for Claude Code..."

          # Ê£ÄÊü•ÂøÖÈúÄÁöÑÁéØÂ¢ÉÂèòÈáè
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "‚ùå ANTHROPIC_API_KEY is not set in cc environment secrets"
            echo "ËØ∑Âú®GitHub‰ªìÂ∫ìÁöÑ Settings > Environments > cc ‰∏≠Ê∑ªÂä† ANTHROPIC_API_KEY secret"
            exit 1
          fi

          # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè‰æõClaude Code‰ΩøÁî®
          echo "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}" >> $GITHUB_ENV
          if [ -n "${{ secrets.ANTHROPIC_BASE_URL }}" ]; then
            echo "ANTHROPIC_BASE_URL=${{ secrets.ANTHROPIC_BASE_URL }}" >> $GITHUB_ENV
            echo "üîó ‰ΩøÁî®ccÁéØÂ¢ÉÁöÑËá™ÂÆö‰πâAPI Base URL: ${{ secrets.ANTHROPIC_BASE_URL }}"
          else
            echo "ANTHROPIC_BASE_URL=https://api.anthropic.com" >> $GITHUB_ENV
            echo "üîó ‰ΩøÁî®ÈªòËÆ§API Base URL"
          fi

          echo "‚úÖ ÁéØÂ¢ÉÂèòÈáèËÆæÁΩÆÂÆåÊàê"
          echo "üîë API Key: ${{ secrets.ANTHROPIC_API_KEY:0:10 }}..."

      - name: Test Plugin Installation
        id: plugin-install
        run: |
          echo "üöÄ Testing plugin installation..."

          # Create a test directory
          mkdir -p /tmp/claude-test
          cd /tmp/claude-test

          # Initialize Claude Code
          echo "üìù Initializing Claude Code test environment..."

          # Install plugin from our repository
          echo "üì¶ Installing plugin from $GITHUB_WORKSPACE..."
          claude plugin install $GITHUB_WORKSPACE || {
            echo "‚ùå Plugin installation failed"
            exit 1
          }

          echo "‚úÖ Plugin installation successful"

          # List installed plugins
          echo "üìã Installed plugins:"
          claude plugin list

          # Save plugin list for verification
          claude plugin list > /tmp/installed-plugins.txt

          # Set output for verification
          echo "PLUGIN_INSTALL_SUCCESS=true" >> $GITHUB_OUTPUT

      - name: Test Plugin Functionality
        if: steps.plugin-install.outputs.PLUGIN_INSTALL_SUCCESS == 'true'
        run: |
          echo "üß™ Testing plugin functionality..."

          cd /tmp/claude-test

          # Test basic plugin commands
          echo "Testing plugin basic functionality..."

          # Test if plugins are properly loaded
          if [ -f "/tmp/installed-plugins.txt" ]; then
            echo "‚úÖ Plugin list saved successfully"
            echo "üìÑ Plugin list content:"
            cat /tmp/installed-plugins.txt
          else
            echo "‚ùå Plugin list not found"
            exit 1
          fi

      - name: Test Plugin Validation
        run: |
          echo "üîç Testing plugin validation..."

          cd $GITHUB_WORKSPACE

          # Run the test script if it exists
          if [ -f "scripts/test-plugin.sh" ]; then
            echo "Running local test script..."
            chmod +x scripts/test-plugin.sh
            ./scripts/test-plugin.sh || {
              echo "‚ùå Test script failed"
              exit 1
            }
            echo "‚úÖ Test script passed"
          else
            echo "‚ö†Ô∏è Test script not found, skipping"
          fi

      - name: Test Evolutionary Biology Expert Plugin
        run: |
          echo "üß¨ Testing evolutionary biology expert plugin..."

          cd /tmp/claude-test

          # Test specific plugin functionality
          echo "Testing evolutionary-biology-expert plugin..."

          # Check if plugin files exist in the workspace
          if [ -d "$GITHUB_WORKSPACE/plugins/evolutionary-biology-expert" ]; then
            echo "‚úÖ Plugin directory exists"

            # Check for required files
            if [ -f "$GITHUB_WORKSPACE/plugins/evolutionary-biology-expert/agents/evolutionary-biology-analyst.md" ]; then
              echo "‚úÖ Agent file exists"
            else
              echo "‚ùå Agent file missing"
            fi

            if [ -f "$GITHUB_WORKSPACE/plugins/evolutionary-biology-expert/templates/expert_analysis_report_template.md" ]; then
              echo "‚úÖ Template file exists"
            else
              echo "‚ùå Template file missing"
            fi

            # Count skills
            skill_count=$(find "$GITHUB_WORKSPACE/plugins/evolutionary-biology-expert/skills" -name "SKILL.md" | wc -l)
            echo "üìö Found $skill_count skills"
          else
            echo "‚ùå Plugin directory not found"
            exit 1
          fi

      - name: Configure Claude Code
        run: |
          echo "‚öôÔ∏è Configuring Claude Code..."

          mkdir -p ~/.claude
          cat > ~/.claude/config.json << EOF
          {
            "defaultModel": "claude-3-5-sonnet-20241022",
            "apiKeys": {
              "anthropic": "${{ secrets.ANTHROPIC_API_KEY }}"
            },
            "allowedTools": [
              "Read", "Write", "Edit", "Bash", "Task",
              "WebSearch", "WebFetch",
              "mcp__sequentialthinking__sequentialthinking",
              "mcp__article_mcp__search_literature",
              "mcp__article_mcp__get_article_details",
              "mcp__article_mcp__get_references",
              "mcp__genome-mcp__get_data",
              "mcp__context7__resolve-library-id",
              "mcp__context7__get-library-docs"
            ],
            "env": {
              "ANTHROPIC_DEFAULT_HAIKU_MODEL": "glm-4.6",
              "ANTHROPIC_DEFAULT_SONNET_MODEL": "glm-4.6",
              "ANTHROPIC_DEFAULT_OPUS_MODEL": "glm-4.6",
              "ANTHROPIC_BASE_URL": "${{ secrets.ANTHROPIC_BASE_URL || 'https://api.anthropic.com' }}"
            },
            "enabledPlugins": {
              "document-skills@anthropic-agent-skills": true,
              "agent-sdk-dev@claude-code-plugins": true,
              "pr-review-toolkit@claude-code-plugins": true,
              "commit-commands@claude-code-plugins": true,
              "evolutionary-biology-expert@cc_plugins": true
            },
            "alwaysThinkingEnabled": false
          }
          EOF

          echo "‚úÖ Claude CodeÈÖçÁΩÆÂÆåÊàê"

      - name: Run Claude Code Integration Tests
        id: claude-test
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          anthropic_base_url: ${{ secrets.ANTHROPIC_BASE_URL }}
          model: claude-3-5-sonnet-20241022
          prompt: |
            ËØ∑È™åËØÅClaude CodeÊèí‰ª∂ÊòØÂê¶Ê≠£Â∏∏Â∑•‰Ωú„ÄÇ

            Ê£ÄÊü•‰ª•‰∏ãÂÜÖÂÆπÔºö
            1. ËøõÂåñÁîüÁâ©Â≠¶‰∏ìÂÆ∂Êèí‰ª∂ÊòØÂê¶Â∑≤ÂÆâË£Ö
            2. Êèí‰ª∂ÊäÄËÉΩÊòØÂê¶ÂèØÁî®
            3. Êèí‰ª∂ÂëΩ‰ª§ÊòØÂê¶ÂèØ‰ª•Ê≠£Â∏∏ÊâßË°å

            ËØ∑ÂàóÂá∫ÊâÄÊúâÂ∑≤ÂÆâË£ÖÁöÑÊèí‰ª∂ÂíåÂèØÁî®ÁöÑÊäÄËÉΩ„ÄÇ

      - name: Test Plugin Uninstallation
        if: always()
        run: |
          echo "üóëÔ∏è Testing plugin uninstallation..."

          cd /tmp/claude-test

          # Uninstall plugins
          claude plugin uninstall all || echo "‚ö†Ô∏è Some plugins might not have uninstalled properly"

          # Verify plugins are uninstalled
          echo "üìã Remaining plugins after uninstallation:"
          claude plugin list || echo "No plugins installed"

          echo "‚úÖ Plugin uninstallation test completed"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run security scan
        run: |
          echo "üîí Running security scan..."

          # Check for sensitive files
          if find . -name "*.key" -o -name "*.pem" -o -name "*.p12" -o -name "id_rsa*" 2>/dev/null | grep -q .; then
            echo "‚ùå Sensitive files found"
            exit 1
          fi

          # Check for hardcoded secrets
          if grep -r "sk-ant-" . --exclude-dir=.git 2>/dev/null | grep -q .; then
            echo "‚ùå Potential API keys found"
            exit 1
          fi

          echo "‚úÖ Security scan passed"