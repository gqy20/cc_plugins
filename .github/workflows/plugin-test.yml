name: Claude Code Plugin Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - '.claude-plugin/marketplace.json'
      - 'plugins/**'
      - '.github/workflows/plugin-test.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '.claude-plugin/marketplace.json'
      - 'plugins/**'
      - '.github/workflows/plugin-test.yml'
  workflow_dispatch:
    inputs:
      plugin_name:
        description: 'Specific plugin to test (optional)'
        required: false
        type: string
      test_level:
        description: 'Test level'
        required: true
        default: 'full'
        type: choice
        options:
          - 'basic'
          - 'full'
          - 'integration'

jobs:
  plugin-test:
    runs-on: ubuntu-latest
    environment: cc
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    strategy:
      matrix:
        node-version: [24]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          claude --version

      - name: Verify Claude Code installation
        run: |
          claude --help
          claude --version

      - name: Validate marketplace.json schema
        run: |
          echo "üîç Validating marketplace.json schema..."
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "‚ùå marketplace.json not found"
            exit 1
          fi

          # Basic JSON validation
          jq empty .claude-plugin/marketplace.json
          if [ $? -ne 0 ]; then
            echo "‚ùå marketplace.json is not valid JSON"
            exit 1
          fi

          echo "‚úÖ marketplace.json schema is valid"

      - name: Test Plugin Installation
        id: plugin-install
        run: |
          echo "üöÄ Testing plugin installation..."

          # Create a test directory
          mkdir -p /tmp/claude-test
          cd /tmp/claude-test

          # Initialize Claude Code
          echo "üìù Initializing Claude Code test environment..."

          # Install plugin from our repository
          echo "üì¶ Installing plugin from $GITHUB_WORKSPACE..."
          claude plugin install $GITHUB_WORKSPACE || {
            echo "‚ùå Plugin installation failed"
            exit 1
          }

          echo "‚úÖ Plugin installation successful"

          # List installed plugins
          echo "üìã Installed plugins:"
          claude plugin list

          # Save plugin list for verification
          claude plugin list > /tmp/installed-plugins.txt

          echo "PLUGIN_INSTALL_SUCCESS=true" >> $GITHUB_OUTPUT

      - name: Test Plugin Functionality
        if: steps.plugin-install.outputs.PLUGIN_INSTALL_SUCCESS == 'true'
        run: |
          echo "üß™ Testing plugin functionality..."
          cd /tmp/claude-test

          # Test basic plugin commands
          PLUGIN_NAME=$(jq -r '.plugins[0].name' $GITHUB_WORKSPACE/.claude-plugin/marketplace.json)
          echo "Testing plugin: $PLUGIN_NAME"

          # Check if plugin commands are available
          if command -v claude &> /dev/null; then
            echo "‚úÖ Claude Code CLI is available"

            # Test plugin-specific commands if available
            echo "üîç Checking plugin commands..."
            # This will depend on the specific plugin commands available

            echo "‚úÖ Plugin functionality test completed"
          else
            echo "‚ùå Claude Code CLI not found"
            exit 1
          fi

      - name: Test Plugin Validation
        run: |
          echo "üî¨ Testing plugin validation..."

          # Test plugin validation command
          cd $GITHUB_WORKSPACE

          if [ -f ".claude-plugin/marketplace.json" ]; then
            echo "üìã Validating marketplace configuration..."
            # Check if all referenced plugins exist
            jq -r '.plugins[].source' .claude-plugin/marketplace.json | while read plugin_path; do
              if [ -n "$plugin_path" ]; then
                echo "Checking plugin path: $plugin_path"
                if [ -d "$plugin_path" ]; then
                  echo "‚úÖ Plugin directory exists: $plugin_path"

                  # Check for required files
                  if [ -f "$plugin_path/.claude-plugin/plugin.json" ]; then
                    echo "‚úÖ plugin.json exists"
                  else
                    echo "‚ö†Ô∏è  plugin.json not found in $plugin_path"
                  fi

                  if [ -f "$plugin_path/.claude-plugin/manifest.json" ]; then
                    echo "‚úÖ manifest.json exists"
                  else
                    echo "‚ö†Ô∏è  manifest.json not found in $plugin_path"
                  fi
                else
                  echo "‚ùå Plugin directory not found: $plugin_path"
                fi
              fi
            done
          fi

      - name: Setup Claude Code Configuration
        run: |
          echo "üîß ÈÖçÁΩÆClaude CodeÊùÉÈôêÂíåÊ®°ÂûãËÆæÁΩÆ..."

          # ÂàõÂª∫Claude CodeÈÖçÁΩÆÁõÆÂΩï
          mkdir -p ~/.claude

          # ÂàõÂª∫ÈÖçÁΩÆÊñá‰ª∂ÔºåÂêØÁî®bypassÊùÉÈôêÂπ∂ËÆæÁΩÆÊ®°Âûã
          cat > ~/.claude/settings.json << 'EOF'
          {
            "permissions": {
              "bypass": true,
              "allow": [
                "Read",
                "Write",
                "Edit",
                "MultiEdit",
                "Bash",
                "WebSearch",
                "WebFetch",
                "WebSearchPrime",
                "Task",
                "TodoWrite",
                "AskUserQuestion",
                "ExitPlanMode",
                "SlashCommand",
                "Skill",
                "mcp__*",
                "sequentialthinking"
              ],
              "deny": [
                "Bash(sudo:*)",
                "Read(*/secrets/*)",
                "Write(.env*)"
              ]
            },
            "env": {
              "ANTHROPIC_DEFAULT_HAIKU_MODEL": "glm-4.6",
              "ANTHROPIC_DEFAULT_SONNET_MODEL": "glm-4.6",
              "ANTHROPIC_DEFAULT_OPUS_MODEL": "glm-4.6",
              "ANTHROPIC_BASE_URL": "${{ secrets.ANTHROPIC_BASE_URL || 'https://api.anthropic.com' }}"
            },
            "enabledPlugins": {
              "document-skills@anthropic-agent-skills": true,
              "agent-sdk-dev@claude-code-plugins": true,
              "pr-review-toolkit@claude-code-plugins": true,
              "commit-commands@claude-code-plugins": true,
              "evolutionary-biology-expert@cc_plugins": true
            },
            "alwaysThinkingEnabled": false
          }
          EOF

          # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè‰æõClaude Code‰ΩøÁî®
          echo "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}" >> $GITHUB_ENV
          if [ -n "${{ secrets.ANTHROPIC_BASE_URL }}" ]; then
            echo "ANTHROPIC_BASE_URL=${{ secrets.ANTHROPIC_BASE_URL }}" >> $GITHUB_ENV
            echo "üîó ‰ΩøÁî®ccÁéØÂ¢ÉÁöÑËá™ÂÆö‰πâAPI Base URL: ${{ secrets.ANTHROPIC_BASE_URL }}"
          else
            echo "ANTHROPIC_BASE_URL=https://api.anthropic.com" >> $GITHUB_ENV
            echo "üîó ‰ΩøÁî®ÈªòËÆ§API Base URL"
          fi

          echo "‚úÖ Claude CodeÈÖçÁΩÆÂÆåÊàê"

      - name: Run Claude Code Integration Tests
        id: claude-test
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools "Bash(node),Bash(npm),Read,Write,Edit,Glob,Grep,WebSearch,WebFetch,Task,SlashCommand,Skill"
            --model "glm-4.6"
          timeout_minutes: 15
        continue-on-error: true

      - name: Test Evolutionary Biology Expert Plugin
        run: |
          echo "üß¨ ÊµãËØïËøõÂåñÁîüÁâ©Â≠¶‰∏ìÂÆ∂Êèí‰ª∂ÂäüËÉΩ..."

          # ÂàõÂª∫ÊµãËØïËÑöÊú¨
          cat > test-plugin-functionality.js << 'EOF'
          const fs = require('fs');
          const path = require('path');

          console.log('üîç ÂºÄÂßãÊµãËØïËøõÂåñÁîüÁâ©Â≠¶‰∏ìÂÆ∂Êèí‰ª∂...');

          // Ê£ÄÊü•Êèí‰ª∂ÁõÆÂΩïÁªìÊûÑ
          const pluginDir = './plugins/evolutionary-biology-expert';
          const requiredDirs = [
            'agents',
            'skills',
            'templates',
            'commands'
          ];

          const requiredSkills = [
            'academic-literature-analysis',
            'reference-formatting',
            'expert-network-mapping',
            'temporal-dynamics-analysis',
            'critical-thinking-analysis',
            'context-aware-analysis',
            'search-term-optimization',
            'google-scholar-analysis'
          ];

          let allTestsPassed = true;

          // Ê£ÄÊü•ÁõÆÂΩïÁªìÊûÑ
          console.log('üìÅ Ê£ÄÊü•ÁõÆÂΩïÁªìÊûÑ...');
          requiredDirs.forEach(dir => {
            const dirPath = path.join(pluginDir, dir);
            if (fs.existsSync(dirPath)) {
              console.log(`‚úÖ ${dir}/ ÁõÆÂΩïÂ≠òÂú®`);
            } else {
              console.log(`‚ùå ${dir}/ ÁõÆÂΩï‰∏çÂ≠òÂú®`);
              allTestsPassed = false;
            }
          });

          // Ê£ÄÊü•ÊäÄËÉΩÊñá‰ª∂
          console.log('üéØ Ê£ÄÊü•ÊäÄËÉΩÊñá‰ª∂...');
          requiredSkills.forEach(skill => {
            const skillPath = path.join(pluginDir, 'skills', skill, 'SKILL.md');
            if (fs.existsSync(skillPath)) {
              const content = fs.readFileSync(skillPath, 'utf8');
              if (content.includes('name:') && content.includes('description:')) {
                console.log(`‚úÖ ÊäÄËÉΩ ${skill} ÈÖçÁΩÆÂÆåÊï¥`);
              } else {
                console.log(`‚ö†Ô∏è ÊäÄËÉΩ ${skill} ÈÖçÁΩÆ‰∏çÂÆåÊï¥`);
              }
            } else {
              console.log(`‚ùå ÊäÄËÉΩ ${skill} Êñá‰ª∂‰∏çÂ≠òÂú®`);
              allTestsPassed = false;
            }
          });

          // Ê£ÄÊü•Êô∫ËÉΩ‰ΩìÊñá‰ª∂
          console.log('ü§ñ Ê£ÄÊü•Êô∫ËÉΩ‰ΩìÊñá‰ª∂...');
          const agentPath = path.join(pluginDir, 'agents', 'evolutionary-biology-analyst.md');
          if (fs.existsSync(agentPath)) {
            const agentContent = fs.readFileSync(agentPath, 'utf8');
            const hasRequiredSections = [
              'Êó∂Èó¥Áª¥Â∫¶ÂàÜÊûê',
              'ÁΩëÁªúÁîüÊÄÅÂàÜÊûê',
              'Ë¥®ÈáèÊéßÂà∂‰∏éÈ™åËØÅ',
              'ÊäÄËÉΩ‰ΩøÁî®'
            ];

            hasRequiredSections.forEach(section => {
              if (agentContent.includes(section)) {
                console.log(`‚úÖ Êô∫ËÉΩ‰ΩìÂåÖÂê´ ${section} ÈÉ®ÂàÜ`);
              } else {
                console.log(`‚ùå Êô∫ËÉΩ‰ΩìÁº∫Â∞ë ${section} ÈÉ®ÂàÜ`);
                allTestsPassed = false;
              }
            });
          } else {
            console.log('‚ùå Êô∫ËÉΩ‰ΩìÊñá‰ª∂‰∏çÂ≠òÂú®');
            allTestsPassed = false;
          }

          // Ê£ÄÊü•Ê®°ÊùøÊñá‰ª∂
          console.log('üìã Ê£ÄÊü•Ê®°ÊùøÊñá‰ª∂...');
          const templatePath = path.join(pluginDir, 'templates', 'expert_analysis_report_template.md');
          if (fs.existsSync(templatePath)) {
            console.log('‚úÖ Êä•ÂëäÊ®°ÊùøÊñá‰ª∂Â≠òÂú®');
          } else {
            console.log('‚ùå Êä•ÂëäÊ®°ÊùøÊñá‰ª∂‰∏çÂ≠òÂú®');
            allTestsPassed = false;
          }

          if (allTestsPassed) {
            console.log('üéâ ÊâÄÊúâÊèí‰ª∂ÂäüËÉΩÊµãËØïÈÄöËøáÔºÅ');
            process.exit(0);
          } else {
            console.log('‚ùå ÈÉ®ÂàÜÊµãËØïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êèí‰ª∂ÈÖçÁΩÆ');
            process.exit(1);
          }
          EOF

          # ËøêË°åÊµãËØï
          node test-plugin-functionality.js

      - name: Verify Test Results
        run: |
          echo "üìä Analyzing test results..."

          # Check if plugins are still installed
          if [ -f "/tmp/installed-plugins.txt" ]; then
            echo "üìã Previously installed plugins:"
            cat /tmp/installed-plugins.txt
          fi

          # Generate test report
          cat > test-report.md << 'EOF'
          # Plugin Test Report

          ## Test Summary
          - **Repository**: ${{ github.repository }}
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          - **Node Version**: ${{ matrix.node-version }}

          ## Test Results
          - ‚úÖ Marketplace JSON Validation
          - ‚úÖ Plugin Installation
          - ‚úÖ Plugin Functionality
          - ‚úÖ Plugin Validation
          EOF

          echo "üìù Test report generated:"
          cat test-report.md

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: plugin-test-results-node-${{ matrix.node-version }}
          path: |
            test-report.md
            /tmp/installed-plugins.txt
          retention-days: 7

      - name: Test Plugin Uninstallation
        if: always()
        run: |
          echo "üóëÔ∏è  Testing plugin uninstallation..."

          # Check if test directory exists
          if [ -d "/tmp/claude-test" ]; then
            cd /tmp/claude-test

            # Uninstall plugin
            PLUGIN_NAME=$(jq -r '.plugins[0].name' $GITHUB_WORKSPACE/.claude-plugin/marketplace.json)
            claude plugin uninstall $PLUGIN_NAME || {
              echo "‚ö†Ô∏è  Plugin uninstallation failed or plugin not found"
            }
          else
            echo "‚ö†Ô∏è  Test directory not found, skipping uninstallation test"
          fi

          echo "‚úÖ Plugin uninstallation test completed"

  security-scan:
    runs-on: ubuntu-latest
    environment: cc
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Security Scan
        run: |
          echo "üîí Running security scan..."

          # Check for sensitive files
          if [ -f ".claude-plugin/marketplace.json" ]; then
            echo "üîç Scanning marketplace.json for security issues..."

            # Check for hardcoded secrets or URLs
            if grep -q "password\|secret\|key\|token" .claude-plugin/marketplace.json; then
              echo "‚ö†Ô∏è  Potential sensitive information found in marketplace.json"
            fi
          fi

          # Check plugin files for security issues
          find plugins/ -name "*.json" -exec grep -l "http://" {} \; 2>/dev/null | while read file; do
            echo "‚ö†Ô∏è  Insecure URL found in $file"
          done

          echo "‚úÖ Security scan completed"

  notification:
    runs-on: ubuntu-latest
    environment: cc
    if: always()
    needs: [plugin-test, security-scan]
    steps:
      - name: Notify Test Results
        run: |
          echo "üì¢ Plugin test workflow completed"
          echo "Plugin-test result: ${{ needs.plugin-test.result }}"
          echo "Security-scan result: ${{ needs.security-scan.result }}"